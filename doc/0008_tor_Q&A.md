tor Q and A
（理解源自各种资料，正确性仅供参考）
##### tor是怎样建立连接的？
![tor连接](https://github.com/linyang23/Q-A-in-level-2/blob/master/photo/tor_1.png)
>参考[Tor原理详解](https://zhuanlan.zhihu.com/p/32445479)
##### tor为什么tor难以追踪？
![tor难以追踪1](https://github.com/linyang23/Q-A-in-level-2/blob/master/photo/tor_2.png)
![tor难以追踪2](https://github.com/linyang23/Q-A-in-level-2/blob/master/photo/tor_3.png)
>参考[Tor-经典暗网技术的原理简介](https://www.bilibili.com/read/cv5684989/)
![tor如何封装](https://github.com/linyang23/Q-A-in-level-2/blob/master/photo/tor_5.png)<br>
- 从外到内，tcp头部-tls头部-被公钥加密的包，在每一个OR处解头部-用私钥解密后获得子包再加上tls头部-tcp头部并传出
- 每条子路径（比如OR1到OR2）上tcp、tls封装只有一层而非三层，到达后被解开，然后送出去再加上
参考文章：《洋葱路由追踪技术中时间特征的建模与分析》
##### tor可能遭受的攻击？
- 被动攻击
    - 观察用户流量模式(发送和接收)
    - 观察用户的内容(用户端与响应方的链接可能是不友好的)
    - 可选项(少数的客户可能会因为与众不同而失去更多的匿名性)
    - 端到端时间相关性(攻击者在发起者和响应者处观察流量模式，将能够以高概率确认通信)(保护：隐藏洋葱代理和第一个Tor节点之间的连接，通过在Tor节点上或在防火墙后运行OP)
    - 端到端大小相关(简单的包计数也可以有效地确认流的端点)
    - 网站指纹(对手可能建立一个指纹数据库，包含文件大小和访问模式的目标网站。稍后，他可以通过查询数据库来确认用户与给定站点的连接)(保护：更大的单元尺寸，将网站分组为大集合的填充方案，以及链接填充或远程假人)
- 主动攻击
    - 控制密钥(一个学习了TLS私钥的攻击者可以模拟该私钥)(但是他还必须学习洋葱密钥来解密创建的单元)(保护：周期性的键旋转限制了这些攻击的机会窗口)
    - 迭代控制(一个可以破坏ORs(通过系统入侵、法律强制或法外强制)的流动对手可以沿着电路破坏节点，直到他到达终点)(由于会话密钥的完美前向保密，一旦电路关闭，攻击者就不能强迫节点解密记录的流量)
    - 运行一个收件人(如果对手可以诱使用户连接到他的web服务器(可能是通过向这些用户投放内容)，他现在就拥有了他们连接的一端)(应用程序协议和相关程序可能会被诱导揭示有关发起者的信息)(保护：Tor依赖Privoxy和类似的协议清除器来解决后一个问题)
    - 运行一个洋葱代理(在希望监视连接到代理的那些人的活动的机构中，代理通常可能需要远程运行)
    - Dos非观察节点(一个只能监视部分Tor网络的观察者可以通过攻击未被观察的节点来关闭它们，降低它们的可靠性)
    - 运行一个敌对OR(一个孤立的敌对节点可以通过自己创建电路，或者改变交通模式来影响其他节点的交通，而如果对手控制了N个节点中的m个，他最多可以关联到(m/N)2个流量)
    - 在消息中引入时间(被动定时攻击的一个较强版本)
    - 标签攻击(敌对节点可以通过改变Cell来标记它)(保护：对单元格进行完整性检查)
    - 替换未经身份验证的协议的内容(在转发未经身份验证的协议(如HTTP)时，敌对的退出节点可以冒充目标服务器)
    - 重播攻击(Tor不容易遭受这种攻击，因为重放握手的一面将导致不同的协商会话密钥，由此记录会话的其余部分不能使用)
    - 诽谤攻击(攻击者可以利用Tor网络进行社会上不赞成的行为，使网络名誉受损，并迫使其运营商关闭它)
    - 分发恶意代码(攻击者可以诱骗用户运行不匿名的Tor软件，或者更糟，诱骗用户运行弱化的软件，使用户的匿名性更低)(保护：使用一个官方公钥对所有Tor版本进行签名，并在目录中包含一个条目，该条目列出了当前认为是安全的版本)(保护：以源代码的形式提供所有版本，鼓励源代码审计)
- 目录服务器攻击
    - 摧毁部分目录服务器(只要任何目录服务器仍在运行，它们仍将广播它们对网络的看法，并生成一个共识目录，如果超过一半被销毁，这个目录将没有足够的签名供客户端自动使用;客户端需要人工干预来决定是否信任生成的目录)
    - 控制单个目录服务器(通过接管目录服务器，攻击者可以部分影响最终目录)
    - 控制大多数目录服务器(控制超过一半目录服务器的对手可以在最终目录中包含任意数量的被攻击者)
    - 鼓励目录服务器异议(说服一些目录服务器操作人员互不信任，那么就会将多数派分成相互敌对的阵营)
    - 欺骗目录服务器列出一个敌对OR(Tor威胁模型明确地假设目录服务器操作员将能够过滤掉大多数恶意攻击者)
    - 使目录相信一个故障OR在正常工作(在当前的Tor实现中，如果目录服务器能够启动某OR的TLS连接，则认为该OR正在正确运行。敌对的OR可以很容易地通过接受来自ORs的TLS连接而忽略所有细胞来破坏这个测试)(保护：目录服务器必须通过构建适当的电路和流来积极地测试ORs)
- 对集合点的攻击
    - 产生许多引入请求(攻击者可能试图通过使用大量请求来拒绝Bob服务)(保护：引入点可以阻止缺少授权令牌的请求)
    - 攻击引入点(通过禁用其引入点来中断位置隐藏服务)(保护：由于服务的标识附加到它的公钥上，因此服务可以简单地在不同的引入点重新宣传自己。广告也可以秘密进行，只有高优先级的客户才知道Bob引入点的地址，或者不同的客户知道不同的介绍点。这迫使攻击者需要禁用所有可能的引入点)
    - 控制点(控制Bob的引入点的攻击者可以用引入请求淹没Bob，或者阻止有效的引入请求到达Bob)(保护：鲍勃可以注意到洪水，并关闭电路。但是，为了注意有效请求的阻塞，他应该定期通过发送会合请求来测试引入点，并确保他收到这些请求)
    - 控制一个集合点
##### tor ip如何封包？
![tor ip](https://github.com/linyang23/Q-A-in-level-2/blob/master/photo/tor_4.png)<br>
- 当用户发送数据包时，最上层说明它需要到达路由器A——电路的第一站。当它被送达那里时，路由器A去掉第一层，下一层指示路由器A将数据包发送到路由器B 。
- 路由器A不知道最终的目的地,只知道包来自用户和去路由器B。路由器B去掉下一层皮,把包送上去C的路径，这一过程持续进行直到消息到达目的地。
- 在每一站，节点只知道数据包的最后一个位置和下一个位置。没有节点能记录数据的完整路径，也没有任何人会观察到被送出去的报文，假设您的前三个服务器配置正确。

#####

